<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iris</title>

    <!--Bootrap-5.3.0-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>

    <!--JQuery-3.6.4-->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
        
    <!--JQuery-csv-1.0.21-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.min.js" integrity="sha512-Y8iWYJDo6HiTo5xtml1g4QqHtl/PO1w+dmUpQfQSOTqKNsMhExfyPN2ncNAe9JuJUSKzwK/b6oaNPop4MXzkwg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="js/data-generation.js"></script>
    <script src="js/confusion-matrix.js"></script>

    <script src="js/neural-network/utils.js"></script>
    <script src="js/neural-network/activation.js"></script>
    <script src="js/neural-network/layer.js"></script>
    <script src="js/neural-network/input-layer.js"></script>
    <script src="js/neural-network/dense-layer.js"></script>
    <script src="js/neural-network/dropout-layer.js"></script>
    <script src="js/neural-network/output-layer.js"></script>
    <script src="js/neural-network/neural-network.js"></script>

    <link href="css/main.css" rel="stylesheet">
    <link href="css/header-small.css" rel="stylesheet">
    <link href="css/section.css" rel="stylesheet">

</head>
<body>
    <header class="row">
        <div class="col-1 col-lg-2"></div>
        <div class="col-10 col-lg-8 d-flex flex-column align-items-start justify-content-center">
            <h1>Iris Dataset</h1>
            <h2>Description of project</h2>
        </div>
        <div class="col-1 col-lg-2"></div>
    </header>

    <section class="row">
        <div class="hidden col-md-1 col-lg-2 col-xxl-3"></div>
        <div class="col-12 col-md-10 col-lg-8 col-xxl-6">
            <h1>Project explanation</h1>
            <p>
                Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed ut tellus auctor, finibus velit eu, bibendum nunc. 
            </p>
            <p>
                Duis vel felis sit amet magna tempor consequat. Ut eget magna vitae mauris semper pharetra ac eu sapien. Integer pulvinar ligula ut arcu ultrices, in blandit massa vestibulum.
            </p>
        </div>
        <div class="hidden col-md-1 col-lg-2 col-xxl-3"></div>
    </section>

    <section class="row">
        <div class="hidden col-md-1 col-lg-2 col-xxl-3"></div>
        <div class="col-12 col-md-10 col-lg-8 col-xxl-6">
            <h1>Result metrics and data</h1>
            <ul class="nav nav-tabs">
                <li class="nav-item">
                  <a class="nav-link active" id="show-metrics">Metrics</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" id="show-data">Data</a>
                </li>
                <li>
                    <a class="nav-link" id="show-network"></a>
                </li>
              </ul>
              <div id="metrics-wrapper">              
                <h2>Precision</h2>
                <div id="precision-wrapper"></div>                
                <h2>Recall</h2>
                <div id="recall-wrapper"></div>                
                <h2>F1 Score</h2>
                <div id="f1score-wrapper"></div>
                <details>
                    <summary>Confusion Matrix</summary>
                    <div id="confusion-matrix-wrapper"></div>  
                </details>
              </div>    
              <div class="d-none" id="data-wrapper"></div>
              <div class="d-none" id="network-visualiser"></div>
        </div>
        <div class="hidden col-md-1 col-lg-2 col-xxl-3"></div>
    </section>

    <section class="row">
        <div class="hidden col-md-1 col-lg-2 col-xxl-3"></div>
        <div class="col-12 col-md-10 col-lg-8 col-xxl-6">
            <h1>Data configuration</h1>
            <div class="input-group mb-3">
                <span class="input-group-text">Split training/testing</span>
                <input type="number" class="form-control" id="train-split" value="0.7" min="0" max="1">
            </div>
        </div>
    </section>

    <section class="row">
        <div class="hidden col-md-1 col-lg-2 col-xxl-3"></div>
        <div class="col-12 col-md-10 col-lg-8 col-xxl-6">
            <h1>Training configuration</h1>
            <div class="input-group mb-3">
                <span class="input-group-text">Epochs</span>
                <input type="number" class="form-control" id="train-epochs" value="5000" min="0" max="100000" step="100">
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text">Learning rate</span>
                <input type="number" class="form-control" id="train-learningrate" value="0.1" min="0" max="0.8" step="0.02">
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text">Batch size</span>
                <input type="number" class="form-control" id="train-batchsize" value="10" min="0" max="150" step="5">
            </div>
            <div class="input-group mb-3">
                <button type="button" class="btn btn-primary" id="test">Test model</button>
            </div>
        </div>
    </section>

    <script>

        function confusionMatrix(labels, matrix){
            let $table = $('<table/>').addClass('table table-bordered');

            let $head = $('<tr/>').append($('<th/>').html('Actual \\ Predicted'));
            for(let i = 0; i < labels.length; i++)
                $head.append($('<th/>').html(labels[i]));
            $table.append($head);

            for(let i = 0; i < labels.length; i++){
                $row = $('<tr/>').append($('<th/>').html(labels[i]));
                for(let j = 0; j < labels.length; j++)
                    $row.append($('<td/>').html(matrix[i][j]));
                $table.append($row);
            }

            return $table;
        }

        function scoreTable(labels, values){
            let $table = $('<table/>').addClass('table table-bordered');

            let $head = $('<tr/>');
            for(let i = 0; i < labels.length; i++)
                $head.append($('<th/>').html(labels[i]));
            $table.append($('<thead>').addClass('table-light').append($head));

            let $row = $('<tr/>');
            for(let i = 0; i < labels.length; i++)
                $row.append($('<td/>').html(values[i].toFixed(2)));
            $table.append($('<tbody>').append($row));

            return $table;
        }

        function tableData(labels, data){
            let $table = $('<table/>').addClass('table table-striped');

            let $head = $('<tr/>')
            for(let i = 0; i < labels.length; i++)                
                $head.append($('<th/>').html(labels[i]));
            $table.append($('<thead/>').addClass('table-dark').append($head));

            let $body = $('<tbody/>');
            for(let i = 0; i < 5; i++){                
                let $row = $('<tr/>');
                for(let j = 0; j < labels.length; j++)                
                    $row.append($('<td/>').html(data[i][j]));
                $body.append($row);
            }
            
            let $row = $('<tr/>');
            for(let j = 0; j < labels.length; j++)                
                $row.append($('<td/>').html('...'));
            $body.append($row);

            $table.append($body);

            return $table;
        }

        $('#test').on('click', async ev => {
            const dataLabels = ['sepal_length', 'sepal_width', 'petal_length', 'petal_width','species'];
            let data = shuffle(await loadCSV('https://gist.githubusercontent.com/curran/a08a1080b88344b0c8a7/raw/0e7a9b0a5d22642a06d3d5b9bcbad9890c8ee534/iris.csv'));
            
            for(let i = 0; i < dataLabels.length; i++)
                if(dataLabels[i] != 'species'){
                    //Convert column to float
                    parseFloatColumn(data, dataLabels[i]);

                    //Normalize column
                    normalizeColumn(data, dataLabels[i], /*max, min*/);
                }


            const splitFraction = parseFloat($('#train-split').val());
            const [trainingData, testingData] = split(data, splitFraction);

            const trainingDataClasses = trainingData.map(row => {
                //Training species one hot vector
                const species = row.species;
                if(species == 'virginica')
                    return [1, 0, 0];
                if(species == 'versicolor')
                    return [0, 1, 0];
                return [0, 0, 1];
            });

            const testingDataClasses = testingData.map(row => row.species);

            const trainingDataFeatures = trainingData.map(row => {
                let ret = [];
                for(let i = 0; i < dataLabels.length; i++)
                    if(dataLabels[i] != 'species')
                        ret.push(row[dataLabels[i]]);
                return ret;
            });
            
            const testingDataFeatures = testingData.map(row => {
                let ret = [];
                for(let i = 0; i < dataLabels.length; i++)
                    if(dataLabels[i] != 'species')
                        ret.push(row[dataLabels[i]]);
                return ret;
            });

            //Network training
            const epochs = parseInt($('#train-epochs').val());
            const learningrate = parseFloat($('#train-learningrate').val());
            const batchsize = parseInt($('#train-batchsize').val());

            const layers = [
                new InputLayer(4),
                new DenseLayer(4, 6, sigmoid, sigmoidPrime),
                new DropoutLayer(6, 6, sigmoid, sigmoidPrime),
                new OutputLayer(6, 3, sigmoid, sigmoidPrime)
            ];

            const network = new NeuralNetwork(layers);
            network.train(trainingDataFeatures, trainingDataClasses, epochs, learningrate, batchsize);

            const predictions = testingDataFeatures.map(row => {
                const p = network.predict(row);
                if(p[0] > 0.5)
                    return 'virginica';
                if(p[1] > 0.5)
                    return 'versicolor';
                return 'setosa';
            });

            const {labels, matrix, precision, recall, f1score} = new ConfusionMatrix(testingDataClasses, predictions);
            
            $('#precision-wrapper').html(scoreTable(labels, precision));            
            $('#recall-wrapper').html(scoreTable(labels, recall));            
            $('#f1score-wrapper').html(scoreTable(labels, f1score));
            
            $('#confusion-matrix-wrapper').html(confusionMatrix(labels, matrix));

        });

        $(() => $('#test').trigger('click'));
        
    </script>
</body>
</html>